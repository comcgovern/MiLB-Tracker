name: Nightly Stats Update

on:
  schedule:
    # Run at 12:01 AM UTC every day during the season (April-September)
    - cron: '1 0 * 4-9 *'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  nightly-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: scripts/requirements.txt

      - name: Install dependencies
        run: pip install -r scripts/requirements.txt

      - name: Fetch previous day's MiLB stats
        run: |
          # Fetch stats from yesterday's minor league games
          python scripts/fetch_stats_by_date.py \
            --yesterday \
            ${{ github.event.inputs.debug == 'true' && '--debug' || '' }}
        env:
          PYTHONUNBUFFERED: '1'

      - name: Fetch previous day's play-by-play data
        run: |
          # Fetch play-by-play data for advanced stats calculation
          python scripts/fetch_pbp.py \
            --yesterday \
            --workers 100 \
            ${{ github.event.inputs.debug == 'true' && '--debug' || '' }}
        env:
          PYTHONUNBUFFERED: '1'

      - name: Calculate advanced stats from PBP
        run: |
          # Calculate GB%, FB%, LD%, Pull%, Pull-Air%, Swing%, Contact%, CSW%, splits
          python scripts/calculate_advanced_stats.py \
            --yesterday \
            ${{ github.event.inputs.debug == 'true' && '--debug' || '' }}
        env:
          PYTHONUNBUFFERED: '1'

      - name: Fetch Statcast data (AAA + FSL)
        run: |
          # Fetch Statcast pitch-level data from Baseball Savant for AAA and Florida State League
          # This enriches the monthly stats files with EV, barrel rate, arsenal, etc.
          python scripts/fetch_statcast.py \
            ${{ github.event.inputs.debug == 'true' && '--debug' || '' }}
        env:
          PYTHONUNBUFFERED: '1'

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            YESTERDAY=$(date -u -d "yesterday" +%Y-%m-%d)
            git commit -m "Fetch play-by-play data for ${YESTERDAY}"
            git push
          fi

  # Trigger deploy after stats update
  trigger-deploy:
    needs: nightly-update
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deployment
        uses: peter-evans/repository-dispatch@v3
        with:
          event-type: stats-updated
